###############################################################################
####################### ESTIMATING DIVERGENCE TIMES ###########################
################################## TUTORIAL ###################################
###############################################################################

######################### JERONYMO DALAPICOLLA, 2019 ##########################
################################     BEAST    #################################
################### STEP 01: INPUT FOR MOLECULAR DATA #########################


###############################################################################
################ Based on Joyce R. Prado and J. P. Huang scripts ##############
###################### KNOWLES LAB, UNIVERSITY OF MICHIGAN ####################
###############################################################################

##1. FOR OTHER STEPS, PLEASE GO TO: https://github.com/jdalapicolla/

##2.INPUTS FOR THIS STEP:
#A. NEXUS FILE WITH UNLIKED SNPS, A MODIFIED FILE FROM .PHYLIP FORMAT, AN OUTPUT OF IPYRAD. CURRENTLY THERE IS NO R PACKAGE THAT CONVERT THE FILES. USE MESQUITE TO DO THAT.


##3. INSTALL AND LOAD THE PACKAGES#
#install the packages
install.packages(c("plyr", "ape"))
#load the packages
#to load multiple packages use the package: 'pacman'. If the package is missing "p_load" will download it from CRAN. Using "" in the name of packages isn't mandatory.
pacman::p_load("plyr", "ape")


##3. CHOOSE A FOLDER FOR ANALYSIS. THE FILES MUST BE THERE! 
#Windows
choose.dir()
#Linux
setwd(tk_choose.dir())

##5. LOAD THE NEXUS FILE:
table = read.nexus.data(file="proe_82.u.snps.nex")

##6. CREATE A VECTOR WITH THE NAMES OF THE SAMPLES IN THE SAME ORDER THAN NEXUS FILE. YOU CAN OPEN THE NEXUS FILE IN A TEXT EDITOR AND THIS LIST IS PROVIDE:
samples = c("ABX005", "ABX020", "AMCC176080", "AMNH269123", "AMNH272700", "BDP2177", "BDP2186", "C247647", "CIT1465", "CIT393", "CIT448", "CIT483", "CIT648", "CIT714", "CTA1028", "CTA4195_MPEG42380", "CTA4245_MPEG42367", "CTA4352_UFES2705", "CTA4363_UFES2834", "CTA4371_UFES2842", "EEB1013", "FMNH175255", "FMNH175275", "FMPS010", "ICA095", "ICA245", "JAP012", "JAP094", "JAP107", "JUF017", "MBR046", "MCNM1497", "MJ515", "MNLM2337", "MNLM519", "MSB140110", "MSB140111", "MSB208394", "MSB211792", "MSB236570", "MSB236689", "MSB236807", "MSB263513", "MSB45836", "MSB70574", "MSB99059", "MUSM23828_AMCC114577", "MVZ157855", "MVZ157905", "MVZ157968", "MVZ160094", "MVZ168955", "MVZ190699", "MVZ194439", "MVZ194493", "MVZ194511", "MVZ194545", "MVZ194567", "MVZ194582_2", "MVZ194874", "MVZ194879", "MVZ194914", "MVZ194987", "MVZ196095", "MVZ225064", "MVZ225082", "NMNH448711", "NMNH448733", "NMNH549559", "NMNH584593", "NUTRIA289", "ROM115116_HP", "TK145304_TTU106013", "TK73760_TTU101118", "TK73888_TTU101173", "TK73977_TTU101213", "UFES1415", "UFES1511", "UFES1517", "UFES4390", "X1M15", "X1M36")

##7. UNLIST THE SNPS PER SAMPLE AND CREATE AN OBJECT FOR EACH SAMPLE:
for (i in samples) {
  x= matrix(unlist(table[i]), nrow = 1, byrow = FALSE)
  assign(i, x)}

##8. CREATE A BIG TABLE WITH ALL SAMPLES OR SELECTED ONLY ONES:
#data_table = rbind(ABX005, ABX020, AMCC176080, AMNH269123, AMNH272700, BDP2177, BDP2186, C247647, CIT1465, CIT393, CIT448, CIT483, CIT648, CIT714, CTA1028, CTA4195_MPEG42380, CTA4245_MPEG42367, CTA4352_UFES2705, CTA4363_UFES2834, CTA4371_UFES2842, EEB1013, FMNH175255, FMNH175275, FMPS010, ICA095, ICA245, JAP012, JAP094, JAP107, JUF017, MBR046, MCNM1497, MJ515, MNLM2337, MNLM519, MSB140110, MSB140111, MSB208394, MSB211792, MSB236570, MSB236689, MSB236807, MSB263513, MSB45836, MSB70574, MSB99059, MUSM23828_AMCC114577, MVZ157855, MVZ157905, MVZ157968, MVZ160094, MVZ168955, MVZ190699, MVZ194439, MVZ194493, MVZ194511, MVZ194545, MVZ194567, MVZ194582_2, MVZ194874, MVZ194879, MVZ194914, MVZ194987, MVZ196095, MVZ225064, MVZ225082, NMNH448711, NMNH448733, NMNH549559, NMNH584593, NUTRIA289, ROM115116_HP, TK145304_TTU106013, TK73760_TTU101118, TK73888_TTU101173, TK73977_TTU101213, UFES1415, UFES1511, UFES1517, UFES4390, X1M15, X1M36)


data_table = rbind(ABX005, CIT1465, CIT714, UFES4390, CIT483, AMCC176080, MVZ194582_2, MVZ194545, MVZ194567, CTA4352_UFES2705, MVZ194914, MSB236689, MVZ194874, CIT648, UFES1517, CTA4371_UFES2842, ICA245, MVZ194511, CTA4195_MPEG42380, JUF017, MVZ160094,  MSB45836,  MSB140110, MVZ196095,   JAP094, MVZ190699, TK73888_TTU101173, AMNH269123, X1M15, CIT393, BDP2177, MVZ157905,  AMNH272700, MVZ157855, FMNH175255, MSB211792, MSB208394, UFES1415, TK73760_TTU101118, MVZ157968,  FMNH175275, MVZ225082, ROM115116_HP, MBR046, CTA1028, EEB1013, FMPS010, NUTRIA289)


#9. REMOVE THE SNPS WITH MORE THAN 75% OF MISSING DATA
y = data_table
y[y=="?"] = NA #replace ? per NA
w = y[, -which(colMeans(is.na(y)) > 0.75)] #remove SNPs with more than 75% of NA, you can decrease to 70% (0.7) if the final number of is too low or high
w[is.na(w)] = "?" #replace NA per ?
#verify the maximum number SNPs
dim(w)

#10. CREATE THE OUTPUT
teste = t(w)
teste = teste[sample(nrow(teste), 6000), ] #replace the number for the number of SNP's required. I selected 6,000 SNP 
teste = t(teste)
#name the samples, or create another vector with codes to help creating the Beast input. I used the code of the clades.

samples2= c("B_ABX_ABX005", "B_CER_CIT1465", "B_XAI_CIT714", "B_LRX_UFES4390", "B_TXI_CIT483", "B_NVZ_AMCC176080", "A_ATH_MVZ194582_2", "A_JMI_MVZ194545", "A_GJR_MVZ194567", "A_LMR_CTA4352_UFES2705", "A_CLJ_MVZ194914", "A_MMR_MSB236689", "A_UJR_MVZ194874", "A_PTI_CIT648", "A_EAM_UFES1517", "A_IJM_CTA4371_UFES2842", "A_NSR_ICA245", "A_SSR_MVZ194511", "C_GUS_CTA4195_MPEG42380", "C_NRB_JUF017", "C_SVZ_MVZ160094", "D_CAM_MSB45836", "D_ECU_MSB140110", "D_MAR_MVZ196095", "D_JAP_JAP094", "D_JUR_MVZ190699", "D_LOR_TK73888_TTU101173", "D_NAR_AMNH269123", "D_SAR_X1M15", "D_MTR_CIT393", "D_UMR_BDP2177", "D_NSM_MVZ157905", "D_SSM_AMNH272700", "D_SPB_MVZ157855", "D_UDM_FMNH175255", "D_PAB_MSB211792", "D_PTC_MSB208394", "D_SCE_UFES1415", "E_IQT_TK73760_TTU101118", "E_STR_MVZ157968", "E_WAM_FMNH175275", "HG_MVZ225082", "TEP_ROM115116_HP", "OUT_MBR046", "OUT_CTA1028", "OUT_EEB1013", "OUT_FMPS010", "OUT_NUTRIA289")


#samples2 = c("ABX_ABX005", "ABX_ABX020", "NVZ_AMCC176080", "NAR_AMNH269123", "SSM_AMNH272700", "UMR_BDP2177", "UMR_BDP2186", "PTI_C247647", "CER_CIT1465", "MTR_CIT393", "MTR_CIT448", "TXI_CIT483", "PTI_CIT648", "XAI_CIT714", "OUT_CTA1028", "GUS_CTA4195_MPEG42380", "NAR_CTA4245_MPEG42367", "LMR_CTA4352_UFES2705", "LMR_CTA4363_UFES2834", "IJM_CTA4371_UFES2842", "OUT_EEB1013", "UDM_FMNH175255", "WAM_FMNH175275", "OUT_FMPS010", "IJM_ICA095", "NSR_ICA245", "NSR_JAP012", "JAP_JAP094", "JAP_JAP107", "NRB_JUF017", "OUT_MBR046", "XAI_MCNM1497", "JMI_MJ515", "CER_MNLM2337", "NRB_MNLM519", "ECU_MSB140110", "ECU_MSB140111", "PTC_MSB208394", "PAB_MSB211792", "ATH_MSB236570", "MMR_MSB236689", "MMR_MSB236807", "OUT_MSB263513", "CAM_MSB45836", "SPB_MSB70574", "PTC_MSB99059", "GJR_MUSM23828_AMCC114577", "SPB_MVZ157855", "NSM_MVZ157905", "STR_MVZ157968", "SVZ_MVZ160094", "WAM_MVZ168955", "JUR_MVZ190699", "SSM_MVZ194439", "JUR_MVZ194493", "SSR_MVZ194511", "JMI_MVZ194545", "GJR_MVZ194567", "ATH_MVZ194582_2", "UJR_MVZ194874", "UJR_MVZ194879", "CLJ_MVZ194914", "CLJ_MVZ194987", "MAR_MVZ196095", "CAM_MVZ225064", "OUT_MVZ225082", "SVZ_NMNH448711", "NVZ_NMNH448733", "SAR_NMNH549559", "SCE_NMNH584593", "OUT_NUTRIA289", "TEP_ROM115116_HP", "GUS_TK145304_TTU106013", "IQT_TK73760_TTU101118", "LOR_TK73888_TTU101173", "NSM_TK73977_TTU101213", "SCE_UFES1415", "TXI_UFES1511", "EAM_UFES1517", "LRX_UFES4390", "SAR_X1M15", "EAM_X1M36")

rownames(teste) = samples2 

#save as nexus file. This will be the input for Beast!
write.nexus.data(teste, "subset_6kl_PRO_48_78pc.nex", format = 'dna')

